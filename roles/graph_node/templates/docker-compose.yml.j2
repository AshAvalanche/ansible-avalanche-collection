version: "3.9"

services:
  ipfs:
    image: ipfs/go-ipfs:latest
    ports:
      - "{{ graph_node.ipfs.port }}:5001"
      - "{{ graph_node.ipfs.gateway_port }}:8082"
    volumes:
      - ipfs-data:/data/ipfs

  postgres:
    image: postgres:13
    environment:
      POSTGRES_USER: {{ graph_node.postgres.user }}
      POSTGRES_PASSWORD: {{ graph_node.postgres.password }}
      POSTGRES_DB: {{ graph_node.postgres.db }}
      POSTGRES_INITDB_ARGS: "--locale=C --encoding=UTF8"
    ports:
      - "{{ graph_node.postgres.port }}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  graph-node:
    image: graphprotocol/graph-node:{{ graph_node.version }}
    depends_on:
      - ipfs
      - postgres
    ports:
      - "{{ graph_node.ports.graphql }}:8000"
      - "{{ graph_node.ports.admin }}:8020"
    environment:
      postgres_host: postgres
      postgres_user: {{ graph_node.postgres.user }}
      postgres_pass: {{ graph_node.postgres.password }}
      postgres_db: {{ graph_node.postgres.db }}
      ipfs: ipfs:{{ graph_node.ipfs.port }}
      ethereum: "{{ graph_node.ethereum.network }}:{{ blockchain_id }}"
      GRAPH_LOG: info

volumes:
  ipfs-data:
  postgres-data:
